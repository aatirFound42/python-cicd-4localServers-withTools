name: Python CI/CD Pipeline

on:
  push:
    branches: [ "main", "develop" ]
    tags: [ 'v*.*.*' ]
  pull_request:
    branches: [ "main", "develop" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: '3.9'

jobs:
  
  # ====== STAGE 1: BUILD ======
  build:
    name: Build Docker Image
    if: "!contains(github.event.head_commit.message, '[deploy-only]')"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set lowercase image name
        run: |
          echo "IMAGE_NAME=$(echo ${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
          
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Display build summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Docker Image Built Successfully"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Image Tags:"
          echo "${{ steps.meta.outputs.tags }}" | sed 's/^/   /'
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ====== STAGE 2: CONTAINER SECURITY SCAN ======
  scan-image:
    name: Scan Docker Image
    if: "!contains(github.event.head_commit.message, '[deploy-only]')"
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: read
      security-events: write  # Required for SARIF upload
    
    steps:
      - name: Set lowercase image name
        run: |
          echo "IMAGE_NAME=$(echo ${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
      
      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Pull Docker image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "Pulling image: $IMAGE"
          docker pull "$IMAGE" || echo "Image not available, skipping scan"
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
        continue-on-error: true
      
      - name: Run Trivy JSON report
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ³ Scanning Docker Image for Vulnerabilities"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Install Trivy
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y
          
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          
          # Run scan and generate JSON report
          trivy image --format json --output trivy-report.json "$IMAGE" || true
          
          if [ -f trivy-report.json ]; then
            # Parse results
            CRITICAL=$(python -c "
            import json
            try:
                with open('trivy-report.json') as f:
                    data = json.load(f)
                    count = 0
                    for result in data.get('Results', []):
                        for vuln in result.get('Vulnerabilities', []):
                            if vuln.get('Severity') == 'CRITICAL':
                                count += 1
                    print(count)
            except:
                print(0)
            " 2>/dev/null || echo "0")
            
            HIGH=$(python -c "
            import json
            try:
                with open('trivy-report.json') as f:
                    data = json.load(f)
                    count = 0
                    for result in data.get('Results', []):
                        for vuln in result.get('Vulnerabilities', []):
                            if vuln.get('Severity') == 'HIGH':
                                count += 1
                    print(count)
            except:
                print(0)
            " 2>/dev/null || echo "0")
            
            echo "Results:"
            echo "  ğŸ”´ Critical: $CRITICAL"
            echo "  ğŸŸ  High:     $HIGH"
            
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo ""
              echo "âš ï¸  Vulnerabilities detected in container image"
              echo "::warning::Trivy detected $CRITICAL critical and $HIGH high severity vulnerabilities"
              
              # Display top 10 vulnerabilities
              echo ""
              echo "Top vulnerabilities:"
              trivy image --format table --severity CRITICAL,HIGH "$IMAGE" | head -n 20
            else
              echo ""
              echo "âœ… No critical or high severity vulnerabilities found"
            fi
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true
      
      - name: Upload Trivy scan results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true
      
      - name: Upload Trivy reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-reports
          path: |
            trivy-results.sarif
            trivy-report.json


  # ====== STAGE 3: LINT ======
  lint:
    name: Code Quality & Linting
    if: "!contains(github.event.head_commit.message, '[deploy-only]')"
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 pylint mypy
      
      - name: Check code formatting with Black
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¨ Checking Code Formatting (Black)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          black --check app/ tests/ --line-length=100 --diff
          echo "âœ… Code formatting verified"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Check import sorting with isort
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Checking Import Order (isort)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          isort --check-only --diff app/ tests/ --profile black
          echo "âœ… Import order verified"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Run Flake8 linting
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Running Flake8 Analysis"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          flake8 app/ tests/ --max-line-length=100 --statistics --show-source
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Run Pylint analysis
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Running Pylint Analysis"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          pylint app/ tests/ --fail-under=8.0 --output-format=colorized
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Run Mypy type checking
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Running Static Type Checking (Mypy)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          mypy app/ --ignore-missing-imports --show-error-codes --pretty
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Run dependency security scan (Safety)
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ›¡ï¸  Scanning Dependencies for Vulnerabilities"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          pip install safety
          
          # Generate requirements for scanning
          if [ -f requirements.txt ]; then
            safety check --file requirements.txt --json > safety-report.json || true
            
            VULN_COUNT=$(python -c "import json; data=json.load(open('safety-report.json')); print(len(data.get('vulnerabilities', [])))" 2>/dev/null || echo "0")
            
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "âš ï¸  Found $VULN_COUNT vulnerable dependencies"
              echo ""
              safety check --file requirements.txt --output text
              echo ""
              echo "::warning::Safety detected $VULN_COUNT vulnerable dependencies"
            else
              echo "âœ… No vulnerable dependencies found"
            fi
          else
            echo "âš ï¸  requirements.txt not found"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true
      
      - name: Upload dependency scan report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safety-report
          path: safety-report.json

      - name: Scan for secrets in git history (TruffleHog)
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Scanning Git History for Secrets"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          pip install truffleHog3
          
          # Scan recent commits (last 10 for performance)
          trufflehog3 --format json --output trufflehog-report.json . || true
          
          if [ -f trufflehog-report.json ]; then
            SECRET_COUNT=$(python -c "
            import json
            try:
                with open('trufflehog-report.json') as f:
                    data = json.load(f)
                    if isinstance(data, list):
                        print(len(data))
                    else:
                        print(0)
            except:
                print(0)
            " 2>/dev/null || echo "0")
            
            if [ "$SECRET_COUNT" -gt 0 ]; then
              echo "âš ï¸  Found $SECRET_COUNT potential secrets in git history"
              echo "::warning::TruffleHog detected $SECRET_COUNT potential secrets"
            else
              echo "âœ… No secrets detected in git history"
            fi
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true
      
      - name: Upload git secrets report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-report
          path: trufflehog-report.json
      
      - name: Linting summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Code Quality Checks Completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ Black formatting"
          echo "âœ“ isort import order"
          echo "âœ“ Flake8 style guide"
          echo "âœ“ Pylint code quality"
          echo "âœ“ Mypy type checking"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"


  # ====== STAGE 4: TEST (MATRIX TESTING) ======
  test:
    name: Test (Python ${{ matrix.python-version }})
    if: "!contains(github.event.head_commit.message, '[deploy-only]')"
    runs-on: ubuntu-latest
    needs: [build, scan-image, lint]
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "âš ï¸  WARNING: requirements.txt not found"
            exit 1
          fi
          
          pip install pytest-xdist pytest-timeout pytest-cov

      - name: Run tests with coverage
        run: |
          if [ ! -d "tests/" ]; then
            echo "âŒ ERROR: tests/ directory not found"
            exit 1
          fi
          
          pytest tests/ \
            -v \
            --tb=short \
            --cov=app \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=json \
            -n auto \
            --timeout=30

      - name: Check coverage threshold (85%)
        run: |
          if [ ! -f coverage.json ]; then
            echo "âŒ ERROR: coverage.json not found"
            exit 1
          fi
          
          python -c "
          import json
          with open('coverage.json') as f:
              data = json.load(f)
              coverage = data['totals']['percent_covered']
              threshold = 85
              print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
              print(f'Coverage Report')
              print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
              print(f'Current:   {coverage:.2f}%')
              print(f'Required:  {threshold}%')
              print(f'Status:    ', end='')
              if coverage < threshold:
                  print(f'âŒ FAILED')
                  print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
                  exit(1)
              else:
                  print(f'âœ… PASSED')
                  print(f'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
          "
      
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html-${{ matrix.python-version }}
          path: htmlcov/
      
      - name: Upload coverage JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-json-${{ matrix.python-version }}
          path: coverage.json
      
      # - name: Run code quality checks
      #   run: |
      #     pip install flake8 pylint
          
      #     echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      #     echo "ğŸ“‹ Running Flake8 Analysis"
      #     echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      #     flake8 app/ tests/ --max-line-length=100 --statistics --exit-zero
          
      #     echo ""
      #     echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      #     echo "ğŸ“‹ Running Pylint Analysis"
      #     echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      #     pylint app/ tests/ --exit-zero
      
      - name: Security scan with Bandit
        run: |
          pip install bandit
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”’ Running Bandit Security Scan"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          bandit -r app/ -f json -o bandit-report.json -ll || true
          
          if [ -f bandit-report.json ]; then
            ISSUE_COUNT=$(python -c "import json; data=json.load(open('bandit-report.json')); print(len(data.get('results', [])))" 2>/dev/null || echo "0")
            
            if [ "$ISSUE_COUNT" -gt 0 ]; then
              echo "âš ï¸  Found $ISSUE_COUNT security issue(s)"
              echo "::warning::Bandit detected $ISSUE_COUNT security issues"
            else
              echo "âœ… No security issues found"
            fi
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          fi
        continue-on-error: true
      
      - name: Secret scanning
        run: |
          pip install detect-secrets
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Running Secret Detection Scan"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          detect-secrets scan --all-files --force-use-all-plugins > .secrets.baseline || true
          
          if [ -f .secrets.baseline ]; then
            SECRET_COUNT=$(python -c "import json; data=json.load(open('.secrets.baseline')); print(len(data.get('results', {})))" 2>/dev/null || echo "0")
            
            if [ "$SECRET_COUNT" -gt 0 ]; then
              echo "âš ï¸  Found $SECRET_COUNT potential secret(s)"
            else
              echo "âœ… No secrets detected"
            fi
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          fi
        continue-on-error: true
      
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-${{ matrix.python-version }}
          path: |
            bandit-report.json
            .secrets.baseline
      
      - name: Test summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Test Suite Completed (Python ${{ matrix.python-version }})"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ Unit Tests"
          echo "âœ“ Integration Tests"
          echo "âœ“ Code Coverage (â‰¥85%)"
          echo "âœ“ Code Quality Checks"
          echo "âœ“ Security Scans"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"


  # ====== STAGE 5: PERFORMANCE TESTING ======
  performance-test:
    name: Performance & Load Testing
    runs-on: ubuntu-latest
    needs: [build, test]
    if: "!contains(github.event.head_commit.message, '[deploy-only]')"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Set lowercase image name
        run: |
          echo "IMAGE_NAME=$(echo ${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Start test container
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Starting Test Container for Performance Testing"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          
          docker pull "$IMAGE"
          
          docker run -d \
            --name perf-test-container \
            -p 8080:5000 \
            -e FLASK_ENV=testing \
            "$IMAGE"
          
          # Wait for container to be ready
          sleep 10
          
          # Health check
          for i in {1..5}; do
            if curl -sf http://localhost:8080/api/health >/dev/null 2>&1; then
              echo "âœ… Container is ready"
              break
            fi
            echo "â³ Waiting for container... ($i/5)"
            sleep 5
          done
      
      - name: Install performance testing tools
        run: |
          pip install locust pytest-benchmark
      
      - name: Run load tests with Locust
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Running Load Tests"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Create a basic locustfile if it doesn't exist
          if [ ! -f tests/performance/locustfile.py ]; then
            mkdir -p tests/performance
            cat > tests/performance/locustfile.py << 'LOCUST_EOF'
          from locust import HttpUser, task, between

          class APIUser(HttpUser):
              wait_time = between(1, 3)
              host = "http://localhost:8080"
              
              @task(3)
              def health_check(self):
                  self.client.get("/api/health")
              
              @task(1)
              def index(self):
                  self.client.get("/")
          LOCUST_EOF
          fi
          
          # Run locust headless
          locust -f tests/performance/locustfile.py \
            --headless \
            --users 50 \
            --spawn-rate 10 \
            --run-time 60s \
            --host http://localhost:8080 \
            --html performance-report.html \
            --csv performance-results || true
          
          echo "âœ… Load tests completed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Analyze performance results
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ˆ Performance Test Results"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ -f performance-results_stats.csv ]; then
            echo "Summary Statistics:"
            cat performance-results_stats.csv
            echo ""
            
            # Check failure rate
            FAILURES=$(tail -n 1 performance-results_stats.csv | cut -d',' -f7 | tr -d ' ')
            echo "Failure Rate: $FAILURES%"
            
            # Fail if failure rate > 5%
            if [ $(echo "$FAILURES > 5.0" | bc -l) -eq 1 ]; then
              echo "âŒ FAILED: Failure rate exceeds 5%"
              exit 1
            else
              echo "âœ… PASSED: Failure rate within acceptable limits"
            fi
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true
      
      - name: Upload performance reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-reports
          path: |
            performance-report.html
            performance-results*.csv
      
      - name: Cleanup test container
        if: always()
        run: |
          docker stop perf-test-container 2>/dev/null || true
          docker rm perf-test-container 2>/dev/null || true


  # ====== STAGE 6: QUALITY GATES ======
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: "!contains(github.event.head_commit.message, '[deploy-only]')"
    
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          path: coverage-artifacts
      
      - name: Analyze coverage across Python versions
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Coverage Analysis Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          for json_file in coverage-artifacts/coverage-json-*/coverage.json; do
            if [ -f "$json_file" ]; then
              version=$(basename $(dirname "$json_file") | sed 's/coverage-json-//')
              coverage=$(python -c "import json; f=open('$json_file'); d=json.load(f); print(f\"{d['totals']['percent_covered']:.2f}\")" 2>&1)
              
              if [ $? -eq 0 ]; then
                echo "Python $version: $coverage%"
              else
                echo "Python $version: âš ï¸  Failed to parse"
              fi
            fi
          done
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        
      - name: Security summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”’ Security Scan Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          echo "Bandit Results:"
          for scan_dir in coverage-artifacts/security-scan-*; do
            if [ -d "$scan_dir" ] && [ -f "$scan_dir/bandit-report.json" ]; then
              version=$(basename "$scan_dir" | sed 's/security-scan-//')
              issues=$(python -c "import json; f=open('$scan_dir/bandit-report.json'); d=json.load(f); print(len(d.get('results', [])))" 2>/dev/null || echo "0")
              
              if [ "$issues" -gt 0 ]; then
                echo "  Python $version: âš ï¸  $issues issue(s)"
              else
                echo "  Python $version: âœ… Clean"
              fi
            fi
          done
          
          echo ""
          echo "Secret Detection:"
          for scan_dir in coverage-artifacts/security-scan-*; do
            if [ -d "$scan_dir" ] && [ -f "$scan_dir/.secrets.baseline" ]; then
              version=$(basename "$scan_dir" | sed 's/security-scan-//')
              secrets=$(python -c "import json; f=open('$scan_dir/.secrets.baseline'); d=json.load(f); print(len(d.get('results', {})))" 2>/dev/null || echo "0")
              
              if [ "$secrets" -gt 0 ]; then
                echo "  Python $version: âš ï¸  $secrets potential secret(s)"
              else
                echo "  Python $version: âœ… Clean"
              fi
            fi
          done
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Comprehensive security summary
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”’ Comprehensive Security Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Dependency vulnerabilities
          if [ -f coverage-artifacts/safety-report/safety-report.json ]; then
            DEPS=$(python -c "import json; data=json.load(open('coverage-artifacts/safety-report/safety-report.json')); print(len(data.get('vulnerabilities', [])))" 2>/dev/null || echo "0")
            echo "Dependencies (Safety):    $([ "$DEPS" -eq 0 ] && echo 'âœ…' || echo 'âš ï¸')  $DEPS vulnerabilities"
          fi
          
          # Git secrets
          if [ -f coverage-artifacts/trufflehog-report/trufflehog-report.json ]; then
            SECRETS=$(python -c "
            import json
            try:
                data = json.load(open('coverage-artifacts/trufflehog-report/trufflehog-report.json'))
                print(len(data) if isinstance(data, list) else 0)
            except:
                print(0)
            " 2>/dev/null || echo "0")
            echo "Git History (TruffleHog): $([ "$SECRETS" -eq 0 ] && echo 'âœ…' || echo 'âš ï¸')  $SECRETS potential secrets"
          fi
          
          # Container vulnerabilities
          if [ -f coverage-artifacts/trivy-reports/trivy-report.json ]; then
            CONTAINER=$(python -c "
            import json
            try:
                data = json.load(open('coverage-artifacts/trivy-reports/trivy-report.json'))
                count = 0
                for result in data.get('Results', []):
                    for vuln in result.get('Vulnerabilities', []):
                        if vuln.get('Severity') in ['CRITICAL', 'HIGH']:
                            count += 1
                print(count)
            except:
                print(0)
            " 2>/dev/null || echo "0")
            echo "Container Image (Trivy):  $([ "$CONTAINER" -eq 0 ] && echo 'âœ…' || echo 'âš ï¸')  $CONTAINER critical/high CVEs"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      - name: Check quality gates
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ¯ Quality Gates Status"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "${{ needs.test.result }}" = "success" ]; then
            echo "âœ… All tests passed"
            echo "âœ… Coverage requirements met"
            echo "âœ… Code quality verified"
            echo ""
            echo "Status: PASSED âœ…"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 0
          else
            echo "âŒ Test failures detected"
            echo ""
            echo "Status: FAILED âŒ"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi


  # ====== STAGE 7: REPORTS ======
  reports:
    name: Generate Reports
    runs-on: ubuntu-latest
    needs: test
    if: "!contains(github.event.head_commit.message, '[deploy-only]')"
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: coverage-artifacts
      
      - name: Generate HTML report index
        run: |
          cat > coverage-artifacts/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ğŸ“Š Test Coverage Reports</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                      padding: 40px 20px;
                  }
                  .container { max-width: 1000px; margin: 0 auto; }
                  .header {
                      background: white;
                      padding: 40px;
                      border-radius: 10px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                      margin-bottom: 30px;
                      text-align: center;
                  }
                  .header h1 { color: #333; font-size: 2.5em; margin-bottom: 10px; }
                  .header p { color: #666; font-size: 1.1em; }
                  .reports-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                      gap: 20px;
                      margin-bottom: 30px;
                  }
                  .report-card {
                      background: white;
                      padding: 30px;
                      border-radius: 10px;
                      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                      transition: all 0.3s ease;
                      text-decoration: none;
                      color: inherit;
                      cursor: pointer;
                  }
                  .report-card:hover {
                      transform: translateY(-5px);
                      box-shadow: 0 15px 30px rgba(0,0,0,0.2);
                  }
                  .report-card h3 { color: #667eea; font-size: 1.3em; margin-bottom: 10px; }
                  .report-card p { color: #666; font-size: 0.9em; margin-bottom: 15px; }
                  .report-link {
                      display: inline-block;
                      background: #667eea;
                      color: white;
                      padding: 10px 20px;
                      border-radius: 5px;
                      text-decoration: none;
                      font-weight: 600;
                      transition: all 0.3s ease;
                  }
                  .report-link:hover { background: #764ba2; }
                  .status {
                      background: white;
                      padding: 30px;
                      border-radius: 10px;
                      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                  }
                  .status h2 { color: #333; margin-bottom: 20px; }
                  .status-item {
                      display: flex;
                      align-items: center;
                      padding: 15px;
                      background: #f5f5f5;
                      border-radius: 5px;
                      margin-bottom: 10px;
                  }
                  .status-icon { font-size: 1.5em; margin-right: 15px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸ“Š Test Coverage Reports</h1>
                      <p>Coverage reports for different Python versions</p>
                  </div>
                  
                  <div class="reports-grid">
                      <a href="coverage-html-3.9/index.html" class="report-card">
                          <h3>ğŸ Python 3.9</h3>
                          <p>Detailed coverage report for Python 3.9 environment</p>
                          <span class="report-link">View Report â†’</span>
                      </a>
                      
                      <a href="coverage-html-3.10/index.html" class="report-card">
                          <h3>ğŸ Python 3.10</h3>
                          <p>Detailed coverage report for Python 3.10 environment</p>
                          <span class="report-link">View Report â†’</span>
                      </a>
                      
                      <a href="coverage-html-3.11/index.html" class="report-card">
                          <h3>ğŸ Python 3.11</h3>
                          <p>Detailed coverage report for Python 3.11 environment</p>
                          <span class="report-link">View Report â†’</span>
                      </a>
                  </div>
                  
                  <div class="status">
                      <h2>ğŸ“ˆ Report Contents</h2>
                      <div class="status-item">
                          <span class="status-icon">ğŸ“Š</span>
                          <div><strong>Overall Coverage</strong> - Total code coverage percentage</div>
                      </div>
                      <div class="status-item">
                          <span class="status-icon">ğŸ“</span>
                          <div><strong>Coverage by File</strong> - Individual file metrics</div>
                      </div>
                      <div class="status-item">
                          <span class="status-icon">ğŸ“</span>
                          <div><strong>Line Coverage</strong> - Exact lines covered/missed</div>
                      </div>
                      <div class="status-item">
                          <span class="status-icon">ğŸ¯</span>
                          <div><strong>Gap Analysis</strong> - Areas needing more tests</div>
                      </div>
                  </div>
              </div>
          </body>
          </html>
          EOF
      
      - name: Upload all reports
        uses: actions/upload-artifact@v4
        with:
          name: all-coverage-reports
          path: coverage-artifacts/


  # ====== STAGE 8: NOTIFICATIONS ======
  notify:
    name: Pipeline Status
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[deploy-only]')"
    needs: [build, scan-image, lint, test, performance-test, quality-gates]
    
    steps:
      - name: Check pipeline status
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Pipeline Execution Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Build:         ${{ needs.build.result }}"
          echo "Image Scan:    ${{ needs.scan-image.result }}"
          echo "Lint:          ${{ needs.lint.result }}"
          echo "Tests:         ${{ needs.test.result }}"
          echo "Performance Test: ${{ needs.performance-test.result }}"
          echo "Quality Gates: ${{ needs.quality-gates.result }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "${{ needs.build.result }}" = "success" ] && \
             [ "${{ needs.scan-image.result }}" = "success" ] && \
             [ "${{ needs.lint.result }}" = "success" ] && \
             [ "${{ needs.test.result }}" = "success" ] && \
             [ "${{ needs.performance-test.result }}" = "success" ] && \
             [ "${{ needs.quality-gates.result }}" = "success" ]; then
            echo ""
            echo "âœ… ALL CHECKS PASSED - READY FOR DEPLOYMENT"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 0
          else
            echo ""
            echo "âŒ PIPELINE FAILED - REVIEW LOGS ABOVE"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi


  # ====== STAGE 9: DEPLOYMENT ======
  deploy-prod:
    name: Deploy to Production
    runs-on: self-hosted
    environment: production
    needs: [build, scan-image, lint, test, performance-test, quality-gates, reports]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify runner environment
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ–¥ï¸  Self-Hosted Runner Verification"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Hostname: $(hostname)"
          echo "User:     $(whoami)"
          echo "Docker:   $(docker --version)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Deploy container
        env:
          CONTAINER_NAME: ${{ secrets.CONTAINER_NAME }}
          CONTAINER_PORT: ${{ secrets.CONTAINER_PORT_HOST }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Starting Deployment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Configuration
          DOCKER_IMAGE="ghcr.io/$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')"
          IMAGE_TAG="latest"
          
          echo "ğŸ“¦ Image:     $DOCKER_IMAGE:$IMAGE_TAG"
          echo "ğŸ·ï¸  Container: $CONTAINER_NAME"
          echo "ğŸ”Œ Port:      $CONTAINER_PORT:5000"
          echo ""
          
          # Validate secrets
          if [ -z "$CONTAINER_NAME" ] || [ -z "$CONTAINER_PORT" ]; then
            echo "âŒ ERROR: Required secrets not configured"
            exit 1
          fi
          
          # Login to registry
          echo "ğŸ” Authenticating to GitHub Container Registry..."
          echo "$GITHUB_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          if [ $? -ne 0 ]; then
            echo "âŒ ERROR: Registry authentication failed"
            exit 1
          fi
          echo "âœ… Authentication successful"
          echo ""
          
          # Stop old container
          echo "ğŸ›‘ Stopping existing container..."
          if docker ps -a | grep -q "$CONTAINER_NAME"; then
            docker stop "$CONTAINER_NAME" 2>&1 || true
            docker rm "$CONTAINER_NAME" 2>&1 || true
            echo "âœ… Old container removed"
          else
            echo "â„¹ï¸  No existing container found"
          fi
          echo ""
          
          # Pull new image
          echo "ğŸ“¥ Pulling Docker image..."
          docker pull "$DOCKER_IMAGE:$IMAGE_TAG"
          
          if [ $? -ne 0 ]; then
            echo "âŒ ERROR: Failed to pull image"
            exit 1
          fi
          echo "âœ… Image pulled successfully"
          echo ""
          
          # Start new container
          echo "ğŸš€ Starting new container..."
          docker run -d \
            --name "$CONTAINER_NAME" \
            -p "$CONTAINER_PORT:5000" \
            -e FLASK_ENV=production \
            -e FLASK_DEBUG=False \
            --restart unless-stopped \
            "$DOCKER_IMAGE:$IMAGE_TAG"
          
          if [ $? -ne 0 ]; then
            echo "âŒ ERROR: Failed to start container"
            exit 1
          fi
          echo "âœ… Container started"
          echo ""
          
          # Health check with retries
          echo "ğŸ¥ Performing health check..."
          HEALTH_SUCCESS=0
          
          for i in {1..3}; do
            sleep 10
            if curl -sf "http://localhost:$CONTAINER_PORT/api/health" --max-time 5 >/dev/null 2>&1; then
              HEALTH_SUCCESS=1
              echo "âœ… Health check passed (attempt $i)"
              break
            else
              echo "â³ Health check attempt $i/3..."
            fi
          done
          
          echo ""
          if [ $HEALTH_SUCCESS -eq 1 ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… DEPLOYMENT SUCCESSFUL"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸŒ Application: http://localhost:$CONTAINER_PORT"
            echo "ğŸ¥ Health:      http://localhost:$CONTAINER_PORT/api/health"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ DEPLOYMENT FAILED - Health Check Timeout"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "ğŸ“‹ Container logs:"
            docker logs "$CONTAINER_NAME" --tail=30
            echo ""
            echo "ğŸ”„ Rolling back..."
            docker stop "$CONTAINER_NAME" 2>&1 || true
            docker rm "$CONTAINER_NAME" 2>&1 || true
            
            if docker images | grep -q "$DOCKER_IMAGE.*latest"; then
              docker run -d \
                --name "$CONTAINER_NAME" \
                -p "$CONTAINER_PORT:5000" \
                --restart unless-stopped \
                "$DOCKER_IMAGE:latest"
              echo "âš ï¸  Rolled back to previous version"
            fi
            exit 1
          fi

      - name: Record deployment metrics
        if: success()
        env:
          DEPLOYMENT_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Recording Deployment Metrics"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Calculate deployment duration
          DEPLOY_START=$(date +%s)
          DEPLOY_END=$(date +%s)
          DURATION=$((DEPLOY_END - DEPLOY_START))
          
          # Prepare metrics payload
          METRICS_PAYLOAD=$(cat <<EOF
          {
            "deployment_id": "${{ github.run_id }}",
            "repository": "${{ github.repository }}",
            "branch": "${{ github.ref_name }}",
            "commit_sha": "${{ github.sha }}",
            "commit_message": "${{ github.event.head_commit.message }}",
            "deployer": "${{ github.actor }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "duration_seconds": $DURATION,
            "status": "success",
            "environment": "production",
            "image_tag": "latest"
          }
          EOF
          )
          
          echo "Metrics to record:"
          echo "$METRICS_PAYLOAD" | jq '.' 2>/dev/null || echo "$METRICS_PAYLOAD"
          
          # Send to metrics endpoint (if configured)
          if [ -n "${{ secrets.METRICS_ENDPOINT }}" ]; then
            curl -X POST "${{ secrets.METRICS_ENDPOINT }}" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${{ secrets.METRICS_API_KEY }}" \
              -d "$METRICS_PAYLOAD" || echo "âš ï¸ Failed to send metrics"
          else
            echo "â„¹ï¸  No metrics endpoint configured (METRICS_ENDPOINT secret not set)"
          fi
          
          # Log to GitHub Actions summary
          echo "### ğŸ“Š Deployment Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment ID | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployer | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Duration | ${DURATION}s |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +%Y-%m-%dT%H:%M:%SZ) |" >> $GITHUB_STEP_SUMMARY
          
          echo "âœ… Deployment metrics recorded"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        continue-on-error: true

      - name: Verify deployment
        env:
          CONTAINER_NAME: ${{ secrets.CONTAINER_NAME }}
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Deployment Verification"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if docker ps | grep -q "$CONTAINER_NAME"; then
            echo "âœ… Container Status: Running"
            echo ""
            docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo ""
            echo "ğŸ“‹ Recent logs:"
            docker logs "$CONTAINER_NAME" --tail=10
          else
            echo "âŒ Container not running"
            exit 1
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Run smoke tests
        env:
          CONTAINER_NAME: ${{ secrets.CONTAINER_NAME }}
          CONTAINER_PORT: ${{ secrets.CONTAINER_PORT_HOST }}
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§ª Running Post-Deployment Smoke Tests"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          BASE_URL="http://localhost:$CONTAINER_PORT"
          FAILED_TESTS=0
          TOTAL_TESTS=0
          
          # Function to run a smoke test
          run_smoke_test() {
            local test_name="$1"
            local endpoint="$2"
            local expected_status="${3:-200}"
            
            TOTAL_TESTS=$((TOTAL_TESTS + 1))
            echo ""
            echo "Test $TOTAL_TESTS: $test_name"
            echo "  Endpoint: $endpoint"
            
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL$endpoint" --max-time 10)
            
            if [ "$HTTP_CODE" = "$expected_status" ]; then
              echo "  âœ… PASSED (HTTP $HTTP_CODE)"
            else
              echo "  âŒ FAILED (Expected HTTP $expected_status, got HTTP $HTTP_CODE)"
              FAILED_TESTS=$((FAILED_TESTS + 1))
            fi
          }
          
          # Critical smoke tests
          run_smoke_test "Health Check" "/api/health" "200"
          run_smoke_test "Root Endpoint" "/" "200"
          
          # Add your application-specific smoke tests
          # run_smoke_test "API Version" "/api/version" "200"
          # run_smoke_test "User List" "/api/users" "200"
          # run_smoke_test "Database Connection" "/api/db/health" "200"
          
          # Response time test
          echo ""
          echo "Test: Response Time"
          RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' "$BASE_URL/api/health")
          RESPONSE_TIME_MS=$(echo "$RESPONSE_TIME * 1000" | bc)
          echo "  Response time: ${RESPONSE_TIME_MS}ms"
          
          if [ $(echo "$RESPONSE_TIME < 1.0" | bc) -eq 1 ]; then
            echo "  âœ… PASSED (< 1000ms)"
          else
            echo "  âš ï¸  WARNING (> 1000ms)"
          fi
          
          # Container health test
          echo ""
          echo "Test: Container Health"
          if docker ps | grep -q "$CONTAINER_NAME.*Up"; then
            echo "  âœ… PASSED (Container is running)"
          else
            echo "  âŒ FAILED (Container is not running)"
            FAILED_TESTS=$((FAILED_TESTS + 1))
          fi
          
          # Memory usage test
          echo ""
          echo "Test: Memory Usage"
          MEMORY_USAGE=$(docker stats --no-stream --format "{{.MemPerc}}" "$CONTAINER_NAME" | sed 's/%//')
          echo "  Memory usage: ${MEMORY_USAGE}%"
          
          if [ $(echo "$MEMORY_USAGE < 80.0" | bc -l) -eq 1 ]; then
            echo "  âœ… PASSED (< 80%)"
          else
            echo "  âš ï¸  WARNING (> 80%)"
          fi
          
          # Results summary
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Smoke Test Results"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Total Tests:  $TOTAL_TESTS"
          echo "Passed:       $((TOTAL_TESTS - FAILED_TESTS))"
          echo "Failed:       $FAILED_TESTS"
          echo ""
          
          if [ $FAILED_TESTS -eq 0 ]; then
            echo "âœ… ALL SMOKE TESTS PASSED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Add to GitHub summary
            echo "### ğŸ§ª Smoke Tests: âœ… PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All $TOTAL_TESTS smoke tests passed successfully." >> $GITHUB_STEP_SUMMARY
            
            exit 0
          else
            echo "âŒ SMOKE TESTS FAILED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Add to GitHub summary
            echo "### ğŸ§ª Smoke Tests: âŒ FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$FAILED_TESTS out of $TOTAL_TESTS tests failed." >> $GITHUB_STEP_SUMMARY
            
            echo ""
            echo "ğŸ”„ INITIATING ROLLBACK DUE TO FAILED SMOKE TESTS"
            
            # Rollback
            docker stop "$CONTAINER_NAME" 2>&1 || true
            docker rm "$CONTAINER_NAME" 2>&1 || true
            
            echo "âš ï¸  Deployment rolled back due to smoke test failures"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          docker logout ghcr.io 2>/dev/null || true
          [ -d ~/.ssh ] && rm -rf ~/.ssh || true


concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: false